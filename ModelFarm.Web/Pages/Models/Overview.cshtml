@page
@model ModelFarm.Web.Pages.Models.OverviewModel
@{
    ViewData["Title"] = "Model Overview";
}

<h4 class="mb-3">Model Overview</h4>

<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">Trained Models</div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush" id="modelList">
                    <div class="list-group-item text-muted small">Loading models...</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-8">
        <div id="modelDetails" style="display:none;">
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-info-circle me-2"></i>Model Details</span>
                    <span id="modelName" class="badge bg-primary"></span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-sm">
                                <tr><td class="text-muted">Configuration</td><td id="detailConfig">-</td></tr>
                                <tr><td class="text-muted">Model Type</td><td id="detailModelType">-</td></tr>
                                <tr><td class="text-muted">Dataset</td><td id="detailDataset">-</td></tr>
                                <tr><td class="text-muted">Trained On</td><td id="detailTrainedOn">-</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-sm">
                                <tr><td class="text-muted">Epochs Trained</td><td id="detailEpochs">-</td></tr>
                                <tr><td class="text-muted">Training Duration</td><td id="detailDuration">-</td></tr>
                                <tr><td class="text-muted">Final Test Loss</td><td id="detailTestLoss">-</td></tr>
                                <tr><td class="text-muted">Meets Requirements</td><td id="detailMeetsReq">-</td></tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header"><i class="bi bi-bar-chart me-2"></i>Performance Metrics</div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col">
                            <div class="fs-4 fw-bold text-primary" id="metricSharpe">-</div>
                            <div class="small text-muted">Sharpe Ratio</div>
                        </div>
                        <div class="col">
                            <div class="fs-4 fw-bold text-success" id="metricReturn">-</div>
                            <div class="small text-muted">Total Return</div>
                        </div>
                        <div class="col">
                            <div class="fs-4 fw-bold text-danger" id="metricDrawdown">-</div>
                            <div class="small text-muted">Max Drawdown</div>
                        </div>
                        <div class="col">
                            <div class="fs-4 fw-bold text-info" id="metricWinRate">-</div>
                            <div class="small text-muted">Win Rate</div>
                        </div>
                        <div class="col">
                            <div class="fs-4 fw-bold text-warning" id="metricProfitFactor">-</div>
                            <div class="small text-muted">Profit Factor</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-3">
                        <div class="card-header"><i class="bi bi-graph-up-arrow me-2"></i>Equity Curve</div>
                        <div class="card-body">
                            <canvas id="equityChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card mb-3">
                        <div class="card-header"><i class="bi bi-water me-2"></i>Drawdown</div>
                        <div class="card-body">
                            <canvas id="drawdownChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-3">
                        <div class="card-header"><i class="bi bi-pie-chart me-2"></i>Win/Loss Distribution</div>
                        <div class="card-body">
                            <canvas id="winLossChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card mb-3">
                        <div class="card-header"><i class="bi bi-graph-up me-2"></i>Rolling Sharpe Ratio</div>
                        <div class="card-body">
                            <canvas id="sharpeChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><i class="bi bi-table me-2"></i>Trade Statistics</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <table class="table table-sm">
                                <tr><td class="text-muted">Total Trades</td><td id="statTotalTrades">-</td></tr>
                                <tr><td class="text-muted">Winning Trades</td><td id="statWinningTrades">-</td></tr>
                                <tr><td class="text-muted">Losing Trades</td><td id="statLosingTrades">-</td></tr>
                            </table>
                        </div>
                        <div class="col-md-4">
                            <table class="table table-sm">
                                <tr><td class="text-muted">Average Win</td><td id="statAvgWin">-</td></tr>
                                <tr><td class="text-muted">Average Loss</td><td id="statAvgLoss">-</td></tr>
                                <tr><td class="text-muted">Largest Win</td><td id="statLargestWin">-</td></tr>
                            </table>
                        </div>
                        <div class="col-md-4">
                            <table class="table table-sm">
                                <tr><td class="text-muted">Largest Loss</td><td id="statLargestLoss">-</td></tr>
                                <tr><td class="text-muted">Max Consecutive Wins</td><td id="statMaxConsecWins">-</td></tr>
                                <tr><td class="text-muted">Max Consecutive Losses</td><td id="statMaxConsecLosses">-</td></tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="noModelSelected" class="card">
            <div class="card-body text-center text-muted py-5">
                <i class="bi bi-graph-up fs-1 mb-3 d-block"></i>
                <p>Select a model from the list to view its performance metrics and charts.</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let currentModels = [];
    let equityChart, drawdownChart, winLossChart, sharpeChart;

    async function loadModels() {
        const res = await fetch('?handler=CompletedJobs');
        const jobs = await res.json();
        currentModels = jobs;
        
        const list = document.getElementById('modelList');
        if (jobs.length === 0) {
            list.innerHTML = '<div class="list-group-item text-muted small">No trained models yet. Complete a training job first.</div>';
            return;
        }
        
        list.innerHTML = jobs.map(j => {
            const meetsReq = j.result?.meetsRequirements;
            const badge = meetsReq 
                ? '<span class="badge bg-success ms-2">?</span>' 
                : '<span class="badge bg-warning ms-2">?</span>';
            return `
                <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" 
                   onclick="selectModel('${j.id}'); return false;">
                    <div>
                        <div class="fw-bold">${j.name}</div>
                        <small class="text-muted">${new Date(j.completedAtUtc).toLocaleDateString()}</small>
                    </div>
                    ${badge}
                </a>
            `;
        }).join('');
    }

    async function selectModel(jobId) {
        const job = currentModels.find(j => j.id === jobId);
        if (!job || !job.result) return;

        // Fetch additional details
        const detailsRes = await fetch(`?handler=ModelDetails&jobId=${jobId}`);
        const details = await detailsRes.json();

        document.getElementById('noModelSelected').style.display = 'none';
        document.getElementById('modelDetails').style.display = 'block';

        const r = job.result;
        const m = r.backtestMetrics;

        // Update model info
        document.getElementById('modelName').textContent = job.name;
        document.getElementById('detailConfig').textContent = details.configName || '-';
        document.getElementById('detailModelType').textContent = details.modelType || '-';
        document.getElementById('detailDataset').textContent = details.datasetName || '-';
        document.getElementById('detailTrainedOn').textContent = job.completedAtUtc 
            ? new Date(job.completedAtUtc).toLocaleString() : '-';
        document.getElementById('detailEpochs').textContent = r.epochsTrained || '-';
        document.getElementById('detailDuration').textContent = formatDuration(r.trainingDuration);
        document.getElementById('detailTestLoss').textContent = r.testLoss?.toFixed(6) || '-';
        document.getElementById('detailMeetsReq').innerHTML = r.meetsRequirements 
            ? '<span class="badge bg-success">Yes</span>' 
            : '<span class="badge bg-warning">No</span>';

        // Update metrics
        document.getElementById('metricSharpe').textContent = m?.sharpeRatio?.toFixed(2) || '-';
        document.getElementById('metricReturn').textContent = m ? `${(m.totalReturn * 100).toFixed(1)}%` : '-';
        document.getElementById('metricDrawdown').textContent = m ? `${(m.maxDrawdown * 100).toFixed(1)}%` : '-';
        document.getElementById('metricWinRate').textContent = m ? `${(m.winRate * 100).toFixed(1)}%` : '-';
        document.getElementById('metricProfitFactor').textContent = m?.profitFactor?.toFixed(2) || '-';

        // Update trade statistics
        const wins = m?.winningTrades || 0;
        const losses = m?.losingTrades || 0;
        document.getElementById('statTotalTrades').textContent = m?.totalTrades || '-';
        document.getElementById('statWinningTrades').textContent = wins;
        document.getElementById('statLosingTrades').textContent = losses;
        document.getElementById('statAvgWin').textContent = m?.averageWin ? `$${m.averageWin.toFixed(2)}` : '-';
        document.getElementById('statAvgLoss').textContent = m?.averageLoss ? `$${m.averageLoss.toFixed(2)}` : '-';
        document.getElementById('statLargestWin').textContent = m?.largestWin ? `$${m.largestWin.toFixed(2)}` : '-';
        document.getElementById('statLargestLoss').textContent = m?.largestLoss ? `$${m.largestLoss.toFixed(2)}` : '-';
        document.getElementById('statMaxConsecWins').textContent = m?.maxConsecutiveWins || '-';
        document.getElementById('statMaxConsecLosses').textContent = m?.maxConsecutiveLosses || '-';

        // Generate sample chart data (in a real app, this would come from the backtest)
        updateCharts(m, details);

        // Highlight selected item
        document.querySelectorAll('#modelList .list-group-item').forEach(el => {
            el.classList.remove('active');
            if (el.onclick?.toString().includes(jobId)) {
                el.classList.add('active');
            }
        });
    }

    function updateCharts(metrics, details) {
        // Destroy existing charts
        [equityChart, drawdownChart, winLossChart, sharpeChart].forEach(c => c?.destroy());

        // Generate sample data points (in production, this would be real backtest data)
        const numPoints = 100;
        const initialCapital = details.initialCapital || 10000;
        const totalReturn = metrics?.totalReturn || 0;
        
        // Simulate equity curve
        const equityData = [];
        let equity = initialCapital;
        for (let i = 0; i <= numPoints; i++) {
            const progress = i / numPoints;
            const noise = (Math.random() - 0.5) * 0.02;
            equity = initialCapital * (1 + (totalReturn * progress) + noise);
            equityData.push(equity);
        }
        
        // Simulate drawdown
        const drawdownData = [];
        let peak = initialCapital;
        for (let i = 0; i < equityData.length; i++) {
            if (equityData[i] > peak) peak = equityData[i];
            const dd = (peak - equityData[i]) / peak * 100;
            drawdownData.push(-dd);
        }

        // Labels
        const labels = Array.from({length: numPoints + 1}, (_, i) => i);

        // Equity Chart
        equityChart = new Chart(document.getElementById('equityChart'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Portfolio Value',
                    data: equityData,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    fill: true,
                    tension: 0.1,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: false },
                    y: { ticks: { callback: v => '$' + v.toLocaleString() } }
                }
            }
        });

        // Drawdown Chart
        drawdownChart = new Chart(document.getElementById('drawdownChart'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Drawdown %',
                    data: drawdownData,
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.3)',
                    fill: true,
                    tension: 0.1,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: false },
                    y: { ticks: { callback: v => v.toFixed(1) + '%' } }
                }
            }
        });

        // Win/Loss Pie Chart
        const wins = metrics?.winningTrades || 0;
        const losses = metrics?.losingTrades || 0;
        winLossChart = new Chart(document.getElementById('winLossChart'), {
            type: 'doughnut',
            data: {
                labels: ['Wins', 'Losses'],
                datasets: [{
                    data: [wins, losses],
                    backgroundColor: ['rgb(75, 192, 192)', 'rgb(255, 99, 132)']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });

        // Rolling Sharpe (simulated)
        const sharpeData = [];
        const baseSharpe = metrics?.sharpeRatio || 1;
        for (let i = 0; i <= numPoints; i++) {
            const noise = (Math.random() - 0.5) * 1;
            sharpeData.push(baseSharpe + noise);
        }

        sharpeChart = new Chart(document.getElementById('sharpeChart'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Rolling Sharpe',
                    data: sharpeData,
                    borderColor: 'rgb(153, 102, 255)',
                    backgroundColor: 'rgba(153, 102, 255, 0.1)',
                    fill: true,
                    tension: 0.1,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: false },
                    y: { 
                        suggestedMin: 0,
                        ticks: { callback: v => v.toFixed(1) }
                    }
                }
            }
        });
    }

    function formatDuration(d) { 
        if (!d) return '-';
        const parts = d.split(':');
        if (parts.length >= 3) {
            const hours = parseInt(parts[0]);
            const mins = parseInt(parts[1]);
            const secs = parseFloat(parts[2]).toFixed(0);
            if (hours > 0) return `${hours}h ${mins}m`;
            return `${mins}m ${secs}s`;
        }
        return d;
    }

    // Init
    loadModels();
</script>
}
